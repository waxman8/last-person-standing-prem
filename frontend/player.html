<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Last Person Standing - Prem - Player</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/vue@3/dist/vue.global.js"></script>
</head>
<body class="bg-gray-100 min-h-screen">
    <div id="app" class="container mx-auto px-4 py-8 max-w-2xl">
        <h1 class="text-3xl font-bold text-center mb-8 text-blue-900">⚽ Last Person Standing - Prem</h1>

        <!-- Login -->
        <div v-if="!token" class="bg-white p-8 rounded-lg shadow-md">
            <h2 class="text-xl font-semibold mb-4">Enter your 5-digit PIN</h2>
            <input v-model="pin" type="password" maxlength="5" class="w-full border p-3 rounded mb-4 text-center text-2xl tracking-widest" placeholder="12345">
            <button @click="login" class="w-full bg-blue-600 text-white font-bold py-3 rounded hover:bg-blue-700 transition">Login</button>
            <p v-if="error" class="text-red-500 mt-4 text-center">{{ error }}</p>

            <div class="mt-8 pt-6 border-t text-center">
                <a href="/index.html" class="text-blue-600 hover:text-blue-800 font-medium">← Back to Home</a>
            </div>
        </div>

        <!-- Dashboard -->
        <div v-else>
            <div class="flex justify-between items-center mb-6">
                <div>
                    <p class="text-gray-600">Welcome,</p>
                    <h2 class="text-2xl font-bold">{{ user.name }}</h2>
                </div>
                <div :class="user.is_active ? 'bg-green-100 text-green-800' : 'bg-red-100 text-red-800'" class="px-4 py-2 rounded-full font-bold">
                    {{ user.is_active ? 'ACTIVE' : 'ELIMINATED' }}
                </div>
            </div>

            <!-- Your Pick / Make Pick Panel -->
            <div v-if="user.is_active" class="mb-8">
                <!-- Already have a pick -->
                <div v-if="myCurrentPick" class="bg-gradient-to-r from-blue-600 to-indigo-700 p-8 rounded-2xl shadow-xl text-white">
                    <h3 class="text-lg font-bold opacity-80 uppercase tracking-widest mb-4">Your pick for this week</h3>
                    <div class="flex items-center justify-between">
                        <div class="flex items-center">
                            <div class="bg-white p-3 rounded-xl mr-6 shadow-lg">
                                <img :src="getLogoUrl(myCurrentPick)" class="w-16 h-16 object-contain" @error="handleLogoError">
                            </div>
                            <div>
                                <p class="text-3xl font-black">{{ myCurrentPick }}</p>
                                <p class="text-blue-100 opacity-75">Good luck! You've got this.</p>
                            </div>
                        </div>
                        <button @click="showPickForm = !showPickForm" class="bg-white/20 hover:bg-white/30 text-white px-4 py-2 rounded-lg font-bold transition">
                            Change Pick
                        </button>
                    </div>
                </div>

                <!-- Show form if no pick OR if user wants to change -->
                <div v-if="!myCurrentPick || showPickForm" class="bg-white p-6 rounded-lg shadow-md mt-4 transition-all duration-300">
                    <h3 class="text-xl font-bold mb-4">Make Your Pick</h3>
                    <div v-if="fixtures.length > 0">
                        <p class="text-sm text-gray-500 mb-4">Select one team to win this week. Deadline: {{ formatDate(fixtures[0].gameweek.deadline) }}</p>
                        <select v-model="selectedTeam" class="w-full border p-3 rounded mb-4">
                            <option value="">-- Choose a Team --</option>
                            <template v-for="f in fixtures">
                                <option :value="f.home_team">{{ f.home_team }} (vs {{ f.away_team }})</option>
                                <option :value="f.away_team">{{ f.away_team }} (vs {{ f.home_team }})</option>
                            </template>
                        </select>

                        <!-- Pick Preview -->
                        <div v-if="selectedTeam" class="flex items-center justify-center mb-6 p-4 border-2 border-dashed border-blue-200 rounded-lg bg-blue-50 transition-all duration-300">
                            <img :src="getLogoUrl(selectedTeam)" class="w-16 h-16 object-contain mr-4 drop-shadow-md" @error="handleLogoError">
                            <div>
                                <p class="text-xs text-blue-600 uppercase font-bold tracking-wider">Your Selection</p>
                                <p class="text-xl font-black text-blue-900">{{ selectedTeam }}</p>
                            </div>
                        </div>

                        <div class="flex gap-2">
                            <button @click="submitPick" class="flex-1 bg-green-600 text-white font-bold py-3 rounded hover:bg-green-700 transition shadow-lg">Confirm Pick</button>
                            <button v-if="myCurrentPick" @click="showPickForm = false" class="px-6 bg-gray-100 text-gray-600 font-bold py-3 rounded hover:bg-gray-200 transition">Cancel</button>
                        </div>
                    </div>
                    <div v-else class="text-center text-gray-500 py-4">No active gameweek or fixtures available.</div>
                    <p v-if="pickMsg" class="mt-4 text-center font-bold" :class="pickMsg.includes('Success') ? 'text-green-600' : 'text-red-600'">{{ pickMsg }}</p>
                </div>
            </div>

            <!-- Inactive Status -->
            <div v-else class="bg-red-50 border-2 border-red-200 p-8 rounded-2xl shadow-sm mb-8 text-center">
                <div class="w-20 h-20 bg-red-100 rounded-full flex items-center justify-center mx-auto mb-4 text-red-500">
                    <svg class="w-12 h-12" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-3L13.732 4c-.77-1.333-2.694-1.333-3.464 0L3.34 16c-.77 1.333.192 3 1.732 3z"></path></svg>
                </div>
                <h3 class="text-2xl font-black text-red-800 mb-2">You have perished!</h3>
                <p class="text-red-600 leading-relaxed">Sorry, you have perished and no longer in the running for the esteemed Last Person Standing.</p>
            </div>

            <!-- History -->
            <div class="bg-white p-6 rounded-lg shadow-md mb-8">
                <h3 class="text-xl font-bold mb-4">My History</h3>
                <div v-if="history.length > 0" class="overflow-x-auto">
                    <table class="w-full text-left">
                        <thead>
                            <tr class="border-b">
                                <th class="pb-2">GW</th>
                                <th class="pb-2">Team</th>
                                <th class="pb-2 text-right">Outcome</th>
                            </tr>
                        </thead>
                        <tbody>
                            <tr v-for="entry in history" :key="entry.gameweek_id" class="border-b last:border-0">
                                <td class="py-2">{{ entry.gameweek_id }}</td>
                                <td class="py-2 flex items-center">
                                    <img :src="getLogoUrl(entry.team_name)" class="w-6 h-6 object-contain mr-2" @error="handleLogoError">
                                    {{ entry.team_name }}
                                </td>
                                <td class="py-2 text-right">
                                    <span :class="{
                                        'text-green-600 font-bold': entry.outcome === 'WON' || entry.outcome.includes('THROUGH'),
                                        'text-red-600 font-bold': entry.outcome === 'LOST',
                                        'text-blue-600 italic': entry.outcome === 'Pending' || entry.outcome === 'In Play',
                                        'text-gray-500 italic': entry.outcome === 'POSTPONED'
                                    }">{{ entry.outcome }}</span>
                                </td>
                            </tr>
                        </tbody>
                    </table>
                </div>
                <div v-else class="text-center text-gray-500 py-4">No history yet.</div>
            </div>

            <!-- Standings -->
            <div class="bg-white p-6 rounded-lg shadow-md">
                <h3 class="text-xl font-bold mb-4">Game Standings</h3>
                <div class="space-y-3">
                    <div v-for="player in standings" class="flex justify-between border-b pb-2">
                        <span :class="{'line-through text-gray-400': !player.is_active}">{{ player.name }}</span>
                        <span class="font-medium min-w-0 ml-4">
                            <span v-if="player.current_pick" class="bg-blue-100 text-blue-800 px-2 py-1 rounded text-sm flex items-center truncate max-w-[150px]" :title="player.current_pick">
                                <img :src="getLogoUrl(player.current_pick)" class="w-4 h-4 object-contain mr-1 flex-shrink-0" @error="handleLogoError">
                                <span class="truncate">{{ player.current_pick }}</span>
                            </span>
                            <span v-else-if="!player.is_active" class="text-red-500 text-sm italic">Out</span>
                            <span v-else class="text-gray-400 text-sm italic">???</span>
                        </span>
                    </div>
                </div>
            </div>

            <button @click="logout" class="mt-8 text-gray-500 hover:underline w-full text-center">Logout</button>
        </div>
    </div>

    <script>
        const { createApp } = Vue;
        createApp({
            data() {
                return {
                    pin: '',
                    token: localStorage.getItem('token'),
                    user: {},
                    fixtures: [],
                    standings: [],
                    history: [],
                    selectedTeam: '',
                    showPickForm: false,
                    error: '',
                    pickMsg: '',
                    teamBadges: {
                        "Arsenal FC": 57,
                        "Aston Villa FC": 58,
                        "AFC Bournemouth": 1044,
                        "Brentford FC": 402,
                        "Brighton & Hove Albion FC": 397,
                        "Chelsea FC": 61,
                        "Crystal Palace FC": 354,
                        "Everton FC": 62,
                        "Fulham FC": 63,
                        "Ipswich Town FC": 349,
                        "Leicester City FC": 338,
                        "Liverpool FC": 64,
                        "Manchester City FC": 65,
                        "Manchester United FC": 66,
                        "Newcastle United FC": 67,
                        "Nottingham Forest FC": 351,
                        "Southampton FC": 340,
                        "Tottenham Hotspur FC": 73,
                        "West Ham United FC": 563,
                        "Wolverhampton Wanderers FC": 76,
                        "Leeds United FC": 341,
                        "Sunderland AFC": 71,
                        "Burnley FC": 328,
                        "Luton Town FC": 389,
                        "Sheffield United FC": 356,
                        "Norwich City FC": 332,
                        "Watford FC": 346
                    }
                }
            },
            computed: {
                myCurrentPick() {
                    if (!this.user || !this.standings || !this.standings.length) return null;
                    const me = this.standings.find(p => p.name === this.user.name);
                    return me ? me.current_pick : null;
                }
            },
            async mounted() {
                if (this.token) {
                    await this.loadData();
                }
            },
            methods: {
                async login() {
                    try {
                        const formData = new FormData();
                        formData.append('username', 'user');
                        formData.append('password', this.pin);
                        const res = await fetch('/login', { method: 'POST', body: formData });
                        const data = await res.json();
                        if (res.ok) {
                            this.token = data.access_token;
                            localStorage.setItem('token', this.token);
                            await this.loadData();
                        } else {
                            this.error = data.detail;
                        }
                    } catch (e) {
                        this.error = "Login failed";
                    }
                },
                logout() {
                    this.token = null;
                    localStorage.removeItem('token');
                },
                async loadData() {
                    const headers = { 'Authorization': `Bearer ${this.token}` };
                    const userRes = await fetch('/me', { headers });
                    this.user = await userRes.json();
                    
                    const fixRes = await fetch('/fixtures', { headers });
                    this.fixtures = await fixRes.json();

                    const standRes = await fetch('/standings', { headers });
                    this.standings = await standRes.json();

                    const histRes = await fetch('/history', { headers });
                    this.history = await histRes.json();
                },
                async submitPick() {
                    if (!this.selectedTeam) return;
                    const headers = { 'Authorization': `Bearer ${this.token}` };
                    const res = await fetch(`/picks?team_name=${encodeURIComponent(this.selectedTeam)}`, { 
                        method: 'POST', 
                        headers 
                    });
                    const data = await res.json();
                    if (res.ok) {
                        this.pickMsg = "Success! Pick saved.";
                        this.showPickForm = false;
                        await this.loadData();
                    } else {
                        this.pickMsg = "Error: " + data.detail;
                    }
                },
                formatDate(dateStr) {
                    return new Date(dateStr).toLocaleString();
                },
                getLogoUrl(teamName) {
                    if (!teamName) return 'https://www.premierleague.com/resources/rebrand/v7.123.14/i/elements/badges/t-default.png';
                    
                    // Direct match
                    let id = this.teamBadges[teamName];
                    
                    // Fuzzy match (handles name variations)
                    if (!id) {
                        const cleanName = teamName.replace(/\s+(FC|AFC|City|United)$/i, '').toLowerCase();
                        const entry = Object.entries(this.teamBadges).find(([name]) =>
                            name.toLowerCase().includes(cleanName)
                        );
                        if (entry) id = entry[1];
                    }

                    if (!id) return 'https://www.premierleague.com/resources/rebrand/v7.123.14/i/elements/badges/t-default.png';
                    // Using .svg as primary and .png as secondary via error handler
                    return `https://crests.football-data.org/${id}.svg`;
                },
                handleLogoError(event) {
                    const fallback = 'https://www.premierleague.com/resources/rebrand/v7.123.14/i/elements/badges/t-default.png';
                    const src = event.target.src;
                    
                    if (src.endsWith('.svg')) {
                        // If SVG fails, try PNG
                        event.target.src = src.replace('.svg', '.png');
                    } else if (src !== fallback) {
                        // If PNG fails, use fallback
                        event.target.src = fallback;
                    }
                }
            }
        }).mount('#app');
    </script>
</body>
</html>
